<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Truth or Dare 抽题</title>
  <style>
    /* 重置与基本布局 */
    body, html {
      margin: 0; padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f0f0f5;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow-x: hidden;
    }

    #container {
      width: 90vw;
      max-width: 480px;
      background: white;
      padding: 2rem 1.5rem;
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

    #question-display {
      min-height: 140px;
      width: 100%;
      font-size: 1.4rem;
      color: #444;
      line-height: 1.5;
      padding: 1.4rem 1.6rem;
      margin-bottom: 2rem;
      text-align: center;
      border-radius: 14px;
      background: #fafaff;
      box-shadow: inset 0 0 12px rgba(0,0,0,0.05);
      user-select: none;
      display: flex; justify-content: center; align-items: center;
      word-break: break-word;
      transition: filter 0.5s ease, opacity 0.5s ease;
    }

    .blur-out {
      filter: blur(6px);
      opacity: 0.3;
    }

    #draw-btn {
      font-size: 1.3rem;
      background: #007aff;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 28px;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(0,122,255,0.4);
      user-select: none;
      transition: background 0.3s ease;
      width: 100%;
      max-width: 300px;
    }

    #draw-btn:hover:not(:disabled) {
      background: #005ecb;
      box-shadow: 0 8px 20px rgba(0,94,203,0.6);
    }

    #draw-btn:disabled {
      background: #999;
      cursor: not-allowed;
      box-shadow: none;
    }

    #switch-db-btn {
      position: absolute;
      top: 14px;
      right: 14px;
      font-size: 0.9rem;
      color: #007aff;
      background: transparent;
      border: none;
      cursor: pointer;
      user-select: none;
      opacity: 0.2;
      transition: opacity 0.3s ease;
      padding: 4px 8px;
      border-radius: 12px;
    }

    #switch-db-btn:hover {
      opacity: 1;
      background: rgba(0, 122, 255, 0.1);
    }

    #db-list {
      position: absolute;
      top: 50px;
      right: 14px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      max-height: 240px;
      overflow-y: auto;
      width: 160px;
      display: none;
      flex-direction: column;
      padding: 8px 0;
      z-index: 10;
    }

    #db-list button {
      border: none;
      background: transparent;
      padding: 10px 16px;
      text-align: left;
      cursor: pointer;
      font-size: 1rem;
      color: #333;
      user-select: none;
      transition: background-color 0.2s ease;
      width: 100%;
    }

    #db-list button:hover {
      background-color: #007aff22;
      color: #007aff;
    }

    @media (max-width: 480px) {
      #container {
        width: 95vw;
        padding: 1.5rem 1rem;
      }
      #draw-btn {
        font-size: 1.1rem;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="container">
    <button id="switch-db-btn" title="切换题库">切换题库▼</button>
    <div id="db-list"></div>
    <div id="question-display">加载中...</div>
    <button id="draw-btn" disabled>抽我</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Firebase 配置
    const firebaseConfig = {
      apiKey: "AIzaSyAu6RnEXYMRsJP3Q8EISNyQRPtbGLDYwkk",
      authDomain: "truth-or-dare-b4b2a.firebaseapp.com",
      databaseURL: "https://truth-or-dare-b4b2a-default-rtdb.firebaseio.com",
      projectId: "truth-or-dare-b4b2a",
      storageBucket: "truth-or-dare-b4b2a.firebasestorage.app",
      messagingSenderId: "643326186626",
      appId: "1:643326186626:web:861df5ec9c5ca8e669d09b",
      measurementId: "G-5TXR8Y8BSR"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();

    const questionDisplay = document.getElementById('question-display');
    const drawBtn = document.getElementById('draw-btn');
    const switchDbBtn = document.getElementById('switch-db-btn');
    const dbListDiv = document.getElementById('db-list');

    let mode = 'truth';  // 从 URL 或默认选择，这里默认 truth
    let currentDbKey = null;
    let currentQuestions = [];
    let allDbs = {};  // { dbKey: [题目数组], ... }

    // 从 URL 参数读取 mode 和 submode (可选)
    function getUrlParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    const urlMode = getUrlParam('mode');
    if (urlMode === 'truth' || urlMode === 'dare') {
      mode = urlMode;
    }

    // 载入所有数据库列表
    async function loadDatabases() {
      questionDisplay.textContent = '加载题库...';
      drawBtn.disabled = true;

      try {
        const snapshot = await db.ref(mode).get();
        if (!snapshot.exists()) {
          questionDisplay.textContent = '题库为空';
          return;
        }
        allDbs = snapshot.val();

        const keys = Object.keys(allDbs);
        if (keys.length === 0) {
          questionDisplay.textContent = '题库为空';
          return;
        }

        currentDbKey = keys[0];
        currentQuestions = allDbs[currentDbKey] || [];

        renderDbList(keys);
        updateCurrentDbDisplay();
        drawBtn.disabled = false;
        questionDisplay.textContent = '点击“抽我”开始抽题';

      } catch (e) {
        questionDisplay.textContent = '加载失败，请稍后重试';
        console.error('读取数据失败', e);
      }
    }

    // 渲染数据库切换列表（隐藏）
    function renderDbList(dbKeys) {
      dbListDiv.innerHTML = '';
      dbKeys.forEach(key => {
        const btn = document.createElement('button');
        btn.textContent = key;
        btn.onclick = () => {
          currentDbKey = key;
          currentQuestions = allDbs[key] || [];
          updateCurrentDbDisplay();
          questionDisplay.textContent = '切换到题库：' + key + '，点击“抽我”开始抽题';
          drawBtn.textContent = '抽我';
          dbListDiv.style.display = 'none';
          drawBtn.disabled = currentQuestions.length === 0;
        };
        dbListDiv.appendChild(btn);
      });
    }

    // 切换数据库按钮显示当前选中数据库
    function updateCurrentDbDisplay() {
      switchDbBtn.textContent = `切换题库 (${currentDbKey}) ▼`;
    }

    // 动画效果，模糊淡出淡入切换题目
    function animateQuestionChange(newQuestion) {
      questionDisplay.classList.add('blur-out');
      setTimeout(() => {
        questionDisplay.textContent = newQuestion;
        questionDisplay.classList.remove('blur-out');
      }, 500);
    }

    // 抽题按钮逻辑
    function drawQuestion() {
      if (currentQuestions.length === 0) {
        questionDisplay.textContent = '无可用题目';
        drawBtn.disabled = true;
        return;
      }
      const idx = Math.floor(Math.random() * currentQuestions.length);
      const question = currentQuestions[idx];
      animateQuestionChange(question);
      drawBtn.textContent = '继续抽我';
    }

    // 绑定事件
    drawBtn.onclick = drawQuestion;
    switchDbBtn.onclick = () => {
      if (dbListDiv.style.display === 'flex') {
        dbListDiv.style.display = 'none';
      } else {
        dbListDiv.style.display = 'flex';
      }
    };

    // 页面初始化
    loadDatabases();
  </script>
</body>
</html>
